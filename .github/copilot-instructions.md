# Copilot Instructions for build.env.intel

## Project Overview

A Quarkus 3.30.6 CLI tool for build environment analysis and SBOM generation. Built with Picocli, targets Java 21 (compiler release), supports GraalVM native compilation. Two main commands: `scan` (environment analysis) and `sbom` (SBOM generation for 16 build systems, including standalone binaries via Syft).

## Architecture

### Command Structure (Picocli)
- **Entry Point**: `EnvScannerCommand` is the `@TopCommand` with `@QuarkusMain`
- **Subcommand**: `SbomCommand` registered via `@Command(subcommands = {SbomCommand.class})`
- **Critical Pattern**: Commands MUST implement `Runnable` with `void run()` - NOT `Callable<Integer>` or method-based approaches
- **Execution**: Quarkus runtime automatically executes the `run()` method

### Cross-Platform Command Execution
**Windows-specific critical pattern**:
```java
List<String> command = new ArrayList<>();
if (System.getProperty("os.name").toLowerCase().contains("win")) {
    command.add("cmd.exe");
    command.add("/c");
} else {
    command.add("sh");
    command.add("-c");
}
command.add(actualCommand);
ProcessBuilder pb = new ProcessBuilder(command);
```
Always wrap shell commands with `cmd.exe /c` on Windows or you'll get "CreateProcess error=2".

### GraalVM Native Image Support
**Reflection Registration Required**: Any class serialized to JSON needs `@RegisterForReflection` with JavaBean getters/setters:
```java
@RegisterForReflection
static class BuildSystemInfo {
    private String buildSystem;
    public String getBuildSystem() { return buildSystem; }
    public void setBuildSystem(String buildSystem) { this.buildSystem = buildSystem; }
}
```
Affects: `BuildSystemInfo`, `ToolVersionInfo`, `FileTypeInfo`

### Build System Generators
- **Registry**: `BuildSystemGeneratorRegistry` registers each `BuildSystemSbomGenerator`
- **Generator Responsibilities**: build file patterns, tool requirements, command construction, project name extraction
- **Extension**: add a new build system by implementing the interface and registering in the registry

### JSON Output Pattern
Both commands always print to console. JSON files are written only when `--json` is specified:
- **scan**: Writes `scan-results.json` (or `--output` path) only with `--json`
- **sbom**: Writes `sbom-summary.json` and per-build log files only with `--json` (SBOM files are always generated by the underlying tools)

## Build System Detection Flow

### Multi-System Detection (SbomCommand)
**Critical**: Uses `EnvScannerCommand.scanFiles()` + `detectDetailedBuildSystems()` to detect all top-level build systems (child modules filtered out).
- Supported systems: Maven, Gradle, npm, Yarn, pnpm, Pipenv, Poetry, uv, Conda, Python, Go, .NET, Rust, PHP, Ruby, Standalone Binaries (Syft)
- Package-manager overrides: Yarn/pnpm override npm; uv/Poetry/Pipenv/Conda override Python
- `--merge` only merges when explicitly set (no automatic merge)
- `--sbom-only` skips detection and runs Syft against the root directory

### Project Name Extraction Pattern
Each build system has dedicated extraction logic:
- **Maven**: Parse `<artifactId>` from `pom.xml`
- **Gradle**: Parse `rootProject.name` from `settings.gradle(.kts)`, fallback to directory
- **npm/Yarn/pnpm**: Parse `"name"` from `package.json`
- **Pipenv/Poetry/uv/Conda**: Use directory name
- **Python**: Parse `name=` from `setup.py` or `name =` from `pyproject.toml`
- **Go**: Extract from `module` directive in `go.mod`
- **.NET**: Parse `<AssemblyName>` from `*.csproj`, fallback to filename
- **Rust**: Parse `[package] name` from `Cargo.toml`
- **PHP**: Parse `"name"` from `composer.json` (strip vendor prefix)
- **Ruby**: Extract from `*.gemspec` filename
- **Standalone Binaries**: Use parent directory name

### Working Directory Strategy
**Critical for SBOM generation**: Commands MUST execute where build files exist:
```java
info.workingDirectory = primaryBuildFile.getParent(); // NOT rootDir
pb.directory(workingDirectory.toFile()); // Set ProcessBuilder directory
```

## Developer Workflows

### Build Commands
```bash
# JVM uber-jar (standard)
./mvnw clean package -Dquarkus.package.jar.type=uber-jar

# Native build
cmd /c "call \"C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\VC\Auxiliary\Build\vcvars64.bat\" && mvn clean package -Pnative"

# Native in Docker (no local GraalVM needed)
./mvnw clean package -Dnative -Dquarkus.native.container-build=true
```

### Testing Commands
```bash
# Run JVM build
java -jar target/quarkus-app/quarkus-run.jar scan --json
java -jar target/quarkus-app/quarkus-run.jar sbom --dry-run

# Dev mode with arguments
./mvnw quarkus:dev -Dquarkus.args="scan --json"
./mvnw quarkus:dev -Dquarkus.args="sbom --merge --json"
```

### CI/CD (.github/workflows/ci.yml)
Three jobs:
1. **build**: JVM build on Temurin JDK 25, uploads `*-runner.jar`
2. **build-native**: GraalVM Community 25, container-build native image, uploads `*-runner`
3. **release**: Tag-based release packaging and GitHub release upload

## Project Conventions

### File Organization
- **SBOM Output**: Defaults to `generated-sboms/` directory (configurable via `--output`)
- **Scan Results**: `scan-results.json` only written with `--json`
- **Summary File**: `sbom-summary.json` only written with `--json`

### Multi-Module Detection
**Maven**: Checks for `<modules>` or `<module>` tags in any `pom.xml`
**Gradle**: Checks for `include(` or `include ` in `settings.gradle(.kts)`

### SBOM Merging
`--merge` flag combines multiple SBOMs (polyglot projects) into `merged-bom.json`

### File Pattern Matching
**Wildcard support for .NET**: Use `findFilesByPattern()` for patterns like `*.csproj`:
```java
String regex = pattern.replace("*", ".*").replace("?", ".");
Files.find(root, Integer.MAX_VALUE, (p, attr) -> p.getFileName().toString().matches(regex))
```

## CycloneDX Integration

### Plugin Commands by Language
Reference `cyclonedx_plugins_by_language.md` for official documentation. Key patterns:
- **Maven/Gradle**: Use CycloneDX plugins with output directory and JSON format
- **npm**: `npm sbom --sbom-format=cyclonedx` (adds `--package-lock-only` when lock files exist without `node_modules`, adds `--workspaces` for workspaces)
- **Yarn/pnpm/Conda/Standalone**: Syft `syft scan dir:<path> -o cyclonedx-json=<file>`
- **Python/Pipenv/Poetry/uv**: `cyclonedx-py` (uv runs via `uv run`)
- **Go**: `go list -m -json all` (module inventory output)
- **.NET**: `dotnet CycloneDX <project> --output-format json -o <dir> -fn <file>`
- **Rust**: `cargo cyclonedx -f json --override-filename <name>` then move to output dir
- **PHP**: `composer CycloneDX:make-sbom --spec-version=1.6 --output-format=JSON --output-file=<file>`
- **Ruby**: `cyclonedx-ruby -o <file>` (XML output)

### Command Construction Pattern
Each build system has a dedicated generator implementing `BuildSystemSbomGenerator`:
```java
public class MavenSbomGenerator implements BuildSystemSbomGenerator {
    @Override
    public String generateSbomCommand(String projectName, File outputDir, Path buildFile, String additionalArgs) {
        return String.format(
            "mvn org.cyclonedx:cyclonedx-maven-plugin:makeAggregateBom " +
            "-DoutputFormat=json -DoutputDirectory=%s -DoutputName=%s-bom",
            outputDir.getAbsolutePath(), projectName
        );
    }
}
```

## Common Pitfalls

1. **ProcessBuilder on Windows**: Always use `cmd.exe /c` wrapper
2. **Reflection for native**: Forget `@RegisterForReflection` = serialization fails
3. **Working directory**: Execute commands in wrong location = build failures
4. **Picocli interface**: Use `Runnable`, not `Callable<Integer>` or method-based
5. **Project names**: Parse from build files, don't use generic prefixes
6. **JSON output**: JSON files are written only when `--json` is set

## Key Files
- `src/main/java/org/hoggmania/EnvScannerCommand.java`: Main entry, scan logic, build system detection
- `src/main/java/org/hoggmania/SbomCommand.java`: SBOM generation, merge logic, summary output
- `src/main/java/org/hoggmania/BuildSystemGeneratorRegistry.java`: Generator registry
- `src/main/java/org/hoggmania/generators/`: Build system-specific SBOM generators
- `pom.xml`: Quarkus 3.30.6, Java 21, packaging profiles
- `.github/workflows/ci.yml`: JVM + native builds and release pipeline
- `cyclonedx_plugins_by_language.md`: CycloneDX tool reference
